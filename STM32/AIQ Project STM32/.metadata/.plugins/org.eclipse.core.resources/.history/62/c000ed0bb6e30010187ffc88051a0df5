/*
 * i2c.c
 *
 *  Created on: 28-Dec-2025
 *      Author: sreer
 */
#include "i2c.h"

void I2C1_Init(void)
{
    GPIOB_CLK_EN();
    I2C1_EN();

    /* PB8 = SCL, PB9 = SDA */
    GPIOB->MODER &= ~((3 << 16) | (3 << 18));
    GPIOB->MODER |=  ((2 << 16) | (2 << 18));   // AF

    GPIOB->OTYPER |= (1 << 8) | (1 << 9);       // Open drain
    GPIOB->OSPEEDR |= (3 << 16) | (3 << 18);    // High speed
    GPIOB->PUPDR |= (1 << 16) | (1 << 18);      // Pull-up

    GPIOB->AFRH &= ~((0xF << 0) | (0xF << 4));
    GPIOB->AFRH |=  (4 << 0) | (4 << 4);        // AF4 = I2C1

    /* Reset I2C */
    I2C1->CR1 |= (1 << 15);
    I2C1->CR1 &= ~(1 << 15);

    I2C1->CR2 = 16;     // APB1 = 16 MHz
    I2C1->CCR = 80;     // 100 kHz
    I2C1->TRISE = 17;

    I2C1->CR1 |= (1 << 0); // Enable I2C
}

void I2C1_Write(uint8_t addr, uint8_t control, uint8_t data)
{
    while(I2C1->SR2 & (1 << 1));          // BUSY

    I2C1->CR1 |= (1 << 8);                // START
    while(!(I2C1->SR1 & (1 << 0)));       // SB

    I2C1->DR = addr;                      // Address
    while(!(I2C1->SR1 & (1 << 1)));       // ADDR
    (void)I2C1->SR2;

    while(!(I2C1->SR1 & (1 << 7)));       // TXE
    I2C1->DR = control;

    while(!(I2C1->SR1 & (1 << 7)));
    I2C1->DR = data;

    while(!(I2C1->SR1 & (1 << 2)));       // BTF
    I2C1->CR1 |= (1 << 9);                // STOP
}


