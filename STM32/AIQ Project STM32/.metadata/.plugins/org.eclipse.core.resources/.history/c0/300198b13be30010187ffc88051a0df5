/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include "stm32f4xx.h"
#include "SGP40SHT4x.h"
#include <stdio.h>
#include <string.h>

SensorData myData;
char msg[100];

int main(void) {
    HAL_Init(); // Assuming use of HAL for boilerplate, or manual RCC config
    UART_Init();
    I2C_Init();

    UART_SendString("System Initialized...\r\n");

    while (1) {
        // 1. Read SHT4x
        SHT4x_Read(&myData);

        // 2. Read SGP40 Raw Value
        SGP40_ReadRaw(&myData);

        // 3. Format Data for UART
        sprintf(msg, "Temp: %.2fC, Hum: %.2f%%, VOC Raw: %u\r\n",
                myData.temperature, myData.humidity, myData.voc_raw);
        UART_SendString(msg);

        // 4. Update OLED (Simplified logic)
        // In a real scenario, use an SSD1306 library call here
        // Update_OLED_Raw(myData.voc_raw);

        HAL_Delay(1000); // Wait 1 second
    }
}

void SHT4x_Read(SensorData *data) {
    uint8_t cmd = SHT4X_MEASURE_HIGH_PREC;
    uint8_t rx_buf[6];

    HAL_I2C_Master_Transmit(&hi2c1, SHT4X_ADDR, &cmd, 1, 100);
    HAL_Delay(10); // Measurement time
    HAL_I2C_Master_Receive(&hi2c1, SHT4X_ADDR, rx_buf, 6, 100);

    uint16_t t_ticks = (rx_buf[0] << 8) | rx_buf[1];
    uint16_t rh_ticks = (rx_buf[3] << 8) | rx_buf[4];

    data->temperature = -45.0f + 175.0f * (float)t_ticks / 65535.0f;
    data->humidity = -6.0f + 125.0f * (float)rh_ticks / 65535.0f;
}

void SGP40_ReadRaw(SensorData *data) {
    uint8_t cmd[2] = {0x26, 0x0F}; // Measure Raw Command
    uint8_t rx_buf[3];

    HAL_I2C_Master_Transmit(&hi2c1, SGP40_ADDR, cmd, 2, 100);
    HAL_Delay(30); // Max wait for SGP40
    HAL_I2C_Master_Receive(&hi2c1, SGP40_ADDR, rx_buf, 3, 100);

    data->voc_raw = (rx_buf[0] << 8) | rx_buf[1];
}

void UART_SendString(char *str) {
    HAL_UART_Transmit(&huart2, (uint8_t*)str, strlen(str), 100);
}
