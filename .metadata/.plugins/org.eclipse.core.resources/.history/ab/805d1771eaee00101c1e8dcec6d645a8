/* USER CODE BEGIN Includes */
#include "ssd1306.h"
#include "ssd1306_fonts.h"
#include <stdio.h>
#include <string.h>
/* USER CODE END Includes */

/* USER CODE BEGIN PV */
I2C_HandleTypeDef hi2c1;    /* I2C Handle */
UART_HandleTypeDef huart2;  /* UART Handle */

const uint8_t SHT4x_ADDR = 0x44 << 1; /* SHT41 I2C Address */
const uint8_t SGP40_ADDR = 0x59 << 1; /* SGP40 I2C Address */

typedef struct {
    float temp;
    float hum;
    uint16_t sraw_voc;
} EnvData_t;

EnvData_t g_data = {0};
/* USER CODE END PV */

/* USER CODE BEGIN 0 */
uint8_t Sensirion_CRC8(uint8_t *data, uint8_t len) {
    uint8_t crc = 0xFF;
    for (uint8_t i = 0; i < len; i++) {
        crc ^= data[i];
        for (uint8_t j = 0; j < 8; j++) {
            if (crc & 0x80) crc = (crc << 1) ^ 0x31;
            else crc <<= 1;
        }
    }
    return crc;
}
/* USER CODE END 0 */

int main(void) {
  HAL_Init();
  SystemClock_Config();
  MX_GPIO_Init();
  MX_USART2_UART_Init();
  MX_I2C1_Init();

  /* USER CODE BEGIN 2 */
  // 1. Initialize Display
  if (ssd1306_Init() != 0) {
      HAL_UART_Transmit(&huart2, (uint8_t*)"OLED Init Failed\r\n", 18, 100);
  }

  char buf[64];
  /* USER CODE END 2 */

  while (1) {
    /* --- 1. Read SHT41 Temperature/Humidity --- */
    uint8_t sht_cmd = 0xFD;
    uint8_t sht_rx[6];
    if (HAL_I2C_Master_Transmit(&hi2c1, SHT4x_ADDR, &sht_cmd, 1, 100) == HAL_OK) {
        HAL_Delay(10); // Wait for measurement
        if (HAL_I2C_Master_Receive(&hi2c1, SHT4x_ADDR, sht_rx, 6, 100) == HAL_OK) {
            g_data.temp = -45.0f + 175.0f * (float)((sht_rx[0] << 8) | sht_rx[1]) / 65535.0f;
            g_data.hum = -6.0f + 125.0f * (float)((sht_rx[3] << 8) | sht_rx[4]) / 65535.0f;
        }
    }

    /* --- 2. Read SGP40 VOC Raw Signal --- */
    uint8_t sgp_cmd[8] = {0x26, 0x0F};
    uint8_t sgp_rx[3];
    uint16_t h_ticks = (uint16_t)(g_data.hum * 65535 / 100);
    uint16_t t_ticks = (uint16_t)((g_data.temp + 45) * 65535 / 175);
    sgp_cmd[2] = h_ticks >> 8; sgp_cmd[3] = h_ticks & 0xFF;
    sgp_cmd[4] = Sensirion_CRC8(&sgp_cmd[2], 2);
    sgp_cmd[5] = t_ticks >> 8; sgp_cmd[6] = t_ticks & 0xFF;
    sgp_cmd[7] = Sensirion_CRC8(&sgp_cmd[5], 2);

    if (HAL_I2C_Master_Transmit(&hi2c1, SGP40_ADDR, sgp_cmd, 8, 100) == HAL_OK) {
        HAL_Delay(30);
        if (HAL_I2C_Master_Receive(&hi2c1, SGP40_ADDR, sgp_rx, 3, 100) == HAL_OK) {
            g_data.sraw_voc = (sgp_rx[0] << 8) | sgp_rx[1];
        }
    }

    /* --- 3. Update Display --- */
    ssd1306_Fill(Black);
    sprintf(buf, "T:%.1f C H:%.1f%%", g_data.temp, g_data.hum);
    ssd1306_SetCursor(2, 0);
    ssd1306_WriteString(buf, Font_7x10, White);

    sprintf(buf, "VOC RAW: %u", g_data.sraw_voc);
    ssd1306_SetCursor(2, 16);
    ssd1306_WriteString(buf, Font_7x10, White);
    ssd1306_UpdateScreen();

    HAL_Delay(1000); // 1Hz Loop
  }
}
